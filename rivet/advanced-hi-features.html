
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Advanced heavy-ion features Â· ALICE Analysis Tutorial</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-block-align/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc/page-toc.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../css/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="coding-conventions.html" />
    
    
    <link rel="prev" href="advanced-topics.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../start/">
            
                <a href="../start/">
            
                    
                    Getting started
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../start/cert.html">
            
                <a href="../start/cert.html">
            
                    
                    Get a Grid certificate
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../building/">
            
                <a href="../building/">
            
                    
                    Build ALICE software
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../building/custom.html">
            
                <a href="../building/custom.html">
            
                    
                    ðŸ§ª Installation via alibuild
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../building/prereq-centos7.html">
            
                <a href="../building/prereq-centos7.html">
            
                    
                    Prerequisites for CentOS 7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../building/prereq-centos8.html">
            
                <a href="../building/prereq-centos8.html">
            
                    
                    Prerequisites for CentOS 8
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../building/prereq-alma9.html">
            
                <a href="../building/prereq-alma9.html">
            
                    
                    Prerequisites for Alma 9
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="../building/prereq-macos.html">
            
                <a href="../building/prereq-macos.html">
            
                    
                    Prerequisites for macOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="../building/prereq-ubuntu.html">
            
                <a href="../building/prereq-ubuntu.html">
            
                    
                    Prerequisites for Ubuntu
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.6" data-path="../building/prereq-fedora.html">
            
                <a href="../building/prereq-fedora.html">
            
                    
                    Prerequisites for Fedora
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.7" data-path="../building/manual-install.html">
            
                <a href="../building/manual-install.html">
            
                    
                    Fall-back manual installation method
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../building/build.html">
            
                <a href="../building/build.html">
            
                    
                    ðŸ›  Build the packages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../building/precomp.html">
            
                <a href="../building/precomp.html">
            
                    
                    ðŸ“¦ Use the precompiled binaries
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../building/devel.html">
            
                <a href="../building/devel.html">
            
                    
                    ðŸ’ª Develop a single package (Experimental)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <a target="_blank" href="https://aliceo2group.github.io/analysis-framework/">
            
                    
                    O2 Analysis Framework Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../analysis/welcome.html">
            
                <a href="../analysis/welcome.html">
            
                    
                    Writing an analysis task
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../analysis/welcome.html">
            
                <a href="../analysis/welcome.html">
            
                    
                    Writing an analysis task
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="../analysis/classes.html">
            
                <a href="../analysis/classes.html">
            
                    
                    AliAnalysisTaskSE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="../analysis/alianalysistaskmytask.html">
            
                <a href="../analysis/alianalysistaskmytask.html">
            
                    
                    Your analysis task
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="../analysis/local.html">
            
                <a href="../analysis/local.html">
            
                    
                    Running locally
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="../analysis/rungrid.html">
            
                <a href="../analysis/rungrid.html">
            
                    
                    Running on Grid
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="../analysis/lego.html">
            
                <a href="../analysis/lego.html">
            
                    
                    The LEGO train system
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.6" data-path="../analysis/monalisa.html">
            
                <a href="../analysis/monalisa.html">
            
                    
                    AliMonitor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.7" data-path="../analysis/oadb.html">
            
                <a href="../analysis/oadb.html">
            
                    
                    Offline analysis database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.8" data-path="../analysis/trouble.html">
            
                <a href="../analysis/trouble.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.9" data-path="../analysis/streamer.html">
            
                <a href="../analysis/streamer.html">
            
                    
                    The ROOT streamer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.10" data-path="../analysis/destructor.html">
            
                <a href="../analysis/destructor.html">
            
                    
                    Destructors
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../analysis/">
            
                <a href="../analysis/">
            
                    
                    Analysis tutorial exercises
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="../analysis/setup.html">
            
                <a href="../analysis/setup.html">
            
                    
                    Step 1 - Setup the tutorial
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="../analysis/running.html">
            
                <a href="../analysis/running.html">
            
                    
                    Step 2 - Running the task
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="../analysis/modify.html">
            
                <a href="../analysis/modify.html">
            
                    
                    Step 3 - Modify the task
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="../analysis/track.html">
            
                <a href="../analysis/track.html">
            
                    
                    Step 4 -The track loop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="../analysis/pid.html">
            
                <a href="../analysis/pid.html">
            
                    
                    Step 5 -Particle identification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="../analysis/MC.html">
            
                <a href="../analysis/MC.html">
            
                    
                    Step 6 -Using Monte Carlo data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="../analysis/grid.html">
            
                <a href="../analysis/grid.html">
            
                    
                    Step 7 -Run your code on GRID
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="../analysis/bonus.html">
            
                <a href="../analysis/bonus.html">
            
                    
                    Bonus content
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.9" data-path="../analysis/hints.html">
            
                <a href="../analysis/hints.html">
            
                    
                    Some hints
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.10" data-path="../analysis/ROOT5-to-6.html">
            
                <a href="../analysis/ROOT5-to-6.html">
            
                    
                    Transition from ROOT5 to ROOT6
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="rivet-tutorial.html">
            
                <a href="rivet-tutorial.html">
            
                    
                    Rivet
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="getting-started.html">
            
                <a href="getting-started.html">
            
                    
                    Getting started with Rivet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="rivet-in-alice.html">
            
                <a href="rivet-in-alice.html">
            
                    
                    Using Rivet in ALICE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="implementing-rivet-analysis.html">
            
                <a href="implementing-rivet-analysis.html">
            
                    
                    Implementing a Rivet analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="hi-features.html">
            
                <a href="hi-features.html">
            
                    
                    Introduction to heavy-ion features
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="reference-manual.html">
            
                <a href="reference-manual.html">
            
                    
                    Reference manual for Rivet in ALICE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="publishing-procedures.html">
            
                <a href="publishing-procedures.html">
            
                    
                    Procedures for publishing Rivet analyses
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="advanced-topics.html">
            
                <a href="advanced-topics.html">
            
                    
                    Advanced topics
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.8" data-path="advanced-hi-features.html">
            
                <a href="advanced-hi-features.html">
            
                    
                    Advanced heavy-ion features
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="coding-conventions.html">
            
                <a href="coding-conventions.html">
            
                    
                    Coding conventions for Rivet plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="references.html">
            
                <a href="references.html">
            
                    
                    References
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Advanced heavy-ion features</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="advanced-heavy-ion-feratures">Advanced heavy-ion feratures</h1>
<p>This section covers more advanced heavy-ion features introduced in Rivet version 2.7.0+. It explains how event mixing is implemented in Rivet and how to use it, as well as it presents the idea of reentrant finalize for analyses which require more than one beam and/or energy within the same analysis.</p>
<p>Please follow the basic tutorial of implementing a Rivet analysis <a href="implementing-rivet-analysis.html">here</a> and a section covering basic heavy-ion features <a href="hi-features.html">here</a> first before going into this section.</p>
<h2 id="postprocessing-with-reentrant-finalize">Postprocessing with reentrant finalize</h2>
<p>Postprocessing is a method that enables to merge results coming from different Rivet runs. This is useful for analyses which require different beams and/or energies to obtain final results, but also is useful when one wants to simply increase the statistics by merging multiple runs for the same beam/energy. Note, that such an analysis must be implemented in a certain way to allow proper running for all modes, so one should take great care when writing it.</p>
<p>In case of running an analysis for different beams/energies, first step is to declare them in the .info file like this:</p>
<pre><code>[...]
Beams: [[p, p], [Pb, Pb]]
# This is _total_ energy of beams, so this becomes 208*2760=574080
Energies: [2760, 574080]
[...]
</code></pre><p>Then, inside the analysis&apos; init function, one should declare objects for each beam/energy separately, e.g.:</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// Initialize PbPb objects</span>
  book(_histNch, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  book(_counterSOW, <span class="hljs-string">&quot;counter.pbpb&quot;</span>); <span class="hljs-comment">// Sum of weights counter for PbPb</span>
  book(_counterNcoll, <span class="hljs-string">&quot;counter.ncoll&quot;</span>); <span class="hljs-comment">// Ncoll counter for PbPb</span>
  <span class="hljs-comment">// Initialize pp objects</span>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> namePP = _mkAxisCode(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;-pp&quot;</span>;
  book(_histNchPP, namePP, refData(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>));
  book(_counterSOWPP, <span class="hljs-string">&quot;counter.pp&quot;</span>); <span class="hljs-comment">// Sum of weights counter for pp</span>
  <span class="hljs-comment">// Book ratios, to be used in finalize</span>
  book(_histRAA, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  [...]
}
</code></pre>
<p>Sill in the analyze method, one can check the beam type and assign the value to a variable (bool isHI, in this case) depending on the beam type</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">const</span> ParticlePair&amp; beam = beams();
<span class="hljs-keyword">if</span> (beam.first.pid() == PID::PROTON &amp;&amp; beam.second.pid() == PID::PROTON) isHI = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beam.first.pid() == PID::LEAD &amp;&amp; beam.second.pid() == PID::LEAD) isHI = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">else</span> {
  MSG_ERROR(<span class="hljs-string">&quot;Beam error (found)!&quot;</span>);
  <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>In the analyze method, one can then use the information gathered about the beam type to steer the analysis as required</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">if</span> (isHI) {
  <span class="hljs-keyword">const</span> HepMC::HeavyIon* hi = event.genEvent()-&gt;heavy_ion();
  <span class="hljs-keyword">if</span> (!hi.ok()) {
    MSG_WARNING(<span class="hljs-string">&quot;HEPMC Heavy ion container needed for this analysis, but not &quot;</span>
                <span class="hljs-string">&quot;found for this event. Skipping.&quot;</span>);
    vetoEvent;
  }
  <span class="hljs-comment">// process PbPb event, fill PbPb histograms</span>
}
<span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// process pp event, fill pp histograms</span>
}
</code></pre>
<p>Finally, the regular finalize method is called, but in case we have entries in the histograms for both beam types, we do an additional step of dividing them one by another to create R_AA plot:</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// Regular finalize, scaling, etc.</span>
  [...]

  <span class="hljs-comment">// Postprocessing of the histograms in case there are</span>
  <span class="hljs-comment">// entries in histograms for both beam types</span>
  <span class="hljs-keyword">if</span> (_histNchPP-&gt;numEntries() &gt; <span class="hljs-number">0</span> &amp;&amp; _histNch-&gt;numEntries() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Initialize and fill R_AA histograms</span>
    divide(_histNch, _histNchPP, _histRAA);
  }
}
</code></pre>
<p>In order to run an analysis in the postprocessing mode one should run an analysis for every beam/energy combination and then use the rivet-merge script with the output files from the previous runs provided as parameters (check rivet-merge --help):</p>
<pre><code>rivet-merge /path/to/result1.yoda /path/to/result2.yoda ...
</code></pre><p>This will use the RAW histograms from you output files (check that your .yoda files contain them, they contain results from the analysis before the final scaling in the finalize method), merge them, and call finalize part of the analysis again on the merged histograms. Now, as all the histograms will be available, the finalize method will (in our case) create and fill R_AA histograms and save them to the output .yoda file containing final results.
<div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7582922983);" id="beware"><i class="fa fa-info-circle"></i> Beware<span id="heading-7582922983"></span></h3></div><div class="panel-body" id="panel-7582922983"><p>There is no information about beam and energy when running rivet-merge script - this should be taken into account when implementing such an analysis. Also note, that an analysis with reentrant finalize should be validated to allow running in every mode, and so in the .info file it should be marked as: <code>Status: REENTRANT</code></p>
</div></div></p>
<p>A full example of an analysis with the reentrant finalize mode enabled is provided below:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// -*- C++ -*-</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Analysis.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Projections/Beam.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Projections/ChargedFinalState.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Tools/Cuts.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Projections/SingleValueProjection.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Tools/AliceCommon.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Projections/AliceCommon.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;Rivet/Projections/HepMCHeavyIon.hh&quot;</span></span>

<span class="hljs-keyword">namespace</span> Rivet {

  <span class="hljs-comment">/// @brief ALICE PbPb at 2.76 TeV R_AA analysis.</span>
  <span class="hljs-keyword">class</span> ALICE_2012_I1127497 : <span class="hljs-keyword">public</span> Analysis {

  <span class="hljs-keyword">public</span>:

    <span class="hljs-comment">/// Constructor</span>
    DEFAULT_RIVET_ANALYSIS_CTOR(ALICE_2012_I1127497);

    <span class="hljs-comment">/// @name Analysis methods</span>
    <span class="hljs-comment">//@{</span>

    <span class="hljs-comment">/// Book histograms and initialise projections before the run</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-comment">// Access the HepMC heavy ion info</span>
      declare(HepMCHeavyIon(), <span class="hljs-string">&quot;HepMC&quot;</span>);

      <span class="hljs-comment">// Declare centrality projection</span>
      declareCentrality(ALICE::V0MMultiplicity(),
        <span class="hljs-string">&quot;ALICE_2015_PBPBCentrality&quot;</span>, <span class="hljs-string">&quot;V0M&quot;</span>, <span class="hljs-string">&quot;V0M&quot;</span>);

      <span class="hljs-comment">// Charged, primary particles with |eta| &lt; 0.5 and pT &gt; 150 MeV</span>
      declare(ALICE::PrimaryParticles(Cuts::abseta &lt; <span class="hljs-number">0.5</span> &amp;&amp;
        Cuts::pT &gt; <span class="hljs-number">150</span>*MeV &amp;&amp; Cuts::abscharge &gt; <span class="hljs-number">0</span>), <span class="hljs-string">&quot;APRIM&quot;</span>);

      <span class="hljs-comment">// Loop over all histograms</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> ihist = <span class="hljs-number">0</span>; ihist &lt; NHISTOS; ++ihist) {

        <span class="hljs-comment">// Initialize PbPb objects</span>
        book(_histNch[PBPB][ihist], ihist+<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> nameCounterPbPb = <span class="hljs-string">&quot;counter.pbpb.&quot;</span> + <span class="hljs-built_in">std</span>::to_string(ihist);
        book(_counterSOW[PBPB][ihist], nameCounterPbPb); <span class="hljs-comment">// Sum of weights counter for PbPb</span>

        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> nameCounterNcoll = <span class="hljs-string">&quot;counter.ncoll.&quot;</span> + <span class="hljs-built_in">std</span>::to_string(ihist);
        book(_counterNcoll[ihist], nameCounterNcoll); <span class="hljs-comment">// Ncoll counter for PbPb</span>

        <span class="hljs-comment">// Initialize pp objects. In principle, only one pp histogram would be</span>
        <span class="hljs-comment">// needed since centrality does not make any difference here. However,</span>
        <span class="hljs-comment">// in some cases in this analysis the binning differ from each other,</span>
        <span class="hljs-comment">// so this is easy-to-implement way to account for that.</span>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> namePP = mkAxisCode(ihist+<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">&quot;-pp&quot;</span>;

        <span class="hljs-comment">// The binning is taken from the reference data</span>
        book(_histNch[PP][ihist], namePP, refData(ihist+<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>));

        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> nameCounterpp = <span class="hljs-string">&quot;counter.pp.&quot;</span> + <span class="hljs-built_in">std</span>::to_string(ihist);
        book(_counterSOW[PP][ihist], nameCounterpp); <span class="hljs-comment">// Sum of weights counter for pp</span>

        <span class="hljs-comment">// Book ratios, to be used in finalize</span>
        book(_histRAA[ihist], ihist+<span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
      }

      <span class="hljs-comment">// Centrality regions keeping boundaries for a certain region.</span>
      <span class="hljs-comment">// Note, that some regions overlap with other regions.</span>
      _centrRegions.clear();
      _centrRegions = {{<span class="hljs-number">0.</span>, <span class="hljs-number">5.</span>},   {<span class="hljs-number">5.</span>, <span class="hljs-number">10.</span>},  {<span class="hljs-number">10.</span>, <span class="hljs-number">20.</span>},
                       {<span class="hljs-number">20.</span>, <span class="hljs-number">30.</span>}, {<span class="hljs-number">30.</span>, <span class="hljs-number">40.</span>}, {<span class="hljs-number">40.</span>, <span class="hljs-number">50.</span>},
                       {<span class="hljs-number">50.</span>, <span class="hljs-number">60.</span>}, {<span class="hljs-number">60.</span>, <span class="hljs-number">70.</span>}, {<span class="hljs-number">70.</span>, <span class="hljs-number">80.</span>},
                       {<span class="hljs-number">0.</span>, <span class="hljs-number">10.</span>},  {<span class="hljs-number">0.</span>, <span class="hljs-number">20.</span>},  {<span class="hljs-number">20.</span>, <span class="hljs-number">40.</span>},
                       {<span class="hljs-number">40.</span>, <span class="hljs-number">60.</span>}, {<span class="hljs-number">40.</span>, <span class="hljs-number">80.</span>}, {<span class="hljs-number">60.</span>, <span class="hljs-number">80.</span>}};

      <span class="hljs-comment">// Find out the beam type, also specified from option.</span>
      <span class="hljs-built_in">string</span> beamOpt = getOption&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">&quot;beam&quot;</span>,<span class="hljs-string">&quot;NONE&quot;</span>);
      <span class="hljs-keyword">if</span> (beamOpt != <span class="hljs-string">&quot;NONE&quot;</span>) {
        MSG_WARNING(<span class="hljs-string">&quot;You are using a specified beam type, instead of using what&quot;</span>
    <span class="hljs-string">&quot;is provided by the generator. &quot;</span>
    <span class="hljs-string">&quot;Only do this if you are completely sure what you are doing.&quot;</span>);
    <span class="hljs-keyword">if</span> (beamOpt==<span class="hljs-string">&quot;PP&quot;</span>) isHI = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beamOpt==<span class="hljs-string">&quot;HI&quot;</span>) isHI = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">else</span> {
      MSG_ERROR(<span class="hljs-string">&quot;Beam error (option)!&quot;</span>);
      <span class="hljs-keyword">return</span>;
          }
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> ParticlePair&amp; beam = beams();
        <span class="hljs-keyword">if</span> (beam.first.pid() == PID::PROTON &amp;&amp; beam.second.pid() == PID::PROTON) isHI = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beam.first.pid() == PID::LEAD &amp;&amp; beam.second.pid() == PID::LEAD)
      isHI = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">else</span> {
      MSG_ERROR(<span class="hljs-string">&quot;Beam error (found)!&quot;</span>);
      <span class="hljs-keyword">return</span>;
    }
      }
    }

    <span class="hljs-comment">/// Perform the per-event analysis</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">analyze</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Event&amp; event)</span> </span>{

      <span class="hljs-comment">// Charged, primary particles with at least pT = 150 MeV</span>
      <span class="hljs-comment">// in eta range of |eta| &lt; 0.5</span>
      Particles chargedParticles =
        apply&lt;ALICE::PrimaryParticles&gt;(event,<span class="hljs-string">&quot;APRIM&quot;</span>).particlesByPt();

      <span class="hljs-comment">// Check type of event.</span>
      <span class="hljs-keyword">if</span> ( isHI ) {

        <span class="hljs-keyword">const</span> HepMCHeavyIon &amp; hi = apply&lt;HepMCHeavyIon&gt;(event, <span class="hljs-string">&quot;HepMC&quot;</span>);
        <span class="hljs-keyword">if</span> (!hi.ok()) {
      MSG_WARNING(<span class="hljs-string">&quot;HEPMC Heavy ion container needed for this analysis, but not &quot;</span>
        <span class="hljs-string">&quot;found for this event. Skipping.&quot;</span>);
      vetoEvent;
    }
        <span class="hljs-comment">// Prepare centrality projection and value</span>
        <span class="hljs-keyword">const</span> CentralityProjection&amp; centrProj =
          apply&lt;CentralityProjection&gt;(event, <span class="hljs-string">&quot;V0M&quot;</span>);
        <span class="hljs-keyword">double</span> centr = centrProj();
        <span class="hljs-comment">// Veto event for too large centralities since those are not used</span>
        <span class="hljs-comment">// in the analysis at all</span>
        <span class="hljs-keyword">if</span> ((centr &lt; <span class="hljs-number">0.</span>) || (centr &gt; <span class="hljs-number">80.</span>)) vetoEvent;

        <span class="hljs-comment">// Fill PbPb histograms and add weights based on centrality value</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> ihist = <span class="hljs-number">0</span>; ihist &lt; NHISTOS; ++ihist) {
          <span class="hljs-keyword">if</span> (inRange(centr, _centrRegions[ihist].first, _centrRegions[ihist].second)) {
            _counterSOW[PBPB][ihist]-&gt;fill();
            _counterNcoll[ihist]-&gt;fill(hi.Ncoll());
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> Particle&amp; p : chargedParticles) {
              <span class="hljs-keyword">double</span> pT = p.pT()/GeV;
              <span class="hljs-keyword">if</span> (pT &lt; <span class="hljs-number">50.</span>) {
                <span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> pTAtBinCenter = _histNch[PBPB][ihist]-&gt;binAt(pT).xMid();
                _histNch[PBPB][ihist]-&gt;fill(pT, <span class="hljs-number">1</span>/pTAtBinCenter);
              }
            }
          }
        }

      }
      <span class="hljs-keyword">else</span> {

        <span class="hljs-comment">// Fill all pp histograms and add weights</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> ihist = <span class="hljs-number">0</span>; ihist &lt; NHISTOS; ++ihist) {
          _counterSOW[PP][ihist]-&gt;fill();
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> Particle&amp; p : chargedParticles) {
            <span class="hljs-keyword">double</span> pT = p.pT()/GeV;
            <span class="hljs-keyword">if</span> (pT &lt; <span class="hljs-number">50.</span>) {
              <span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> pTAtBinCenter = _histNch[PP][ihist]-&gt;binAt(pT).xMid();
              _histNch[PP][ihist]-&gt;fill(pT, <span class="hljs-number">1</span>/pTAtBinCenter);
            }
          }
        }

      }

    }


    <span class="hljs-comment">/// Normalise histograms etc., after the run</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-comment">// Right scaling of the histograms with their individual weights.</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> itype = <span class="hljs-number">0</span>; itype &lt; EVENT_TYPES; ++itype ) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> ihist = <span class="hljs-number">0</span>; ihist &lt; NHISTOS; ++ihist) {
          <span class="hljs-keyword">if</span> (_counterSOW[itype][ihist]-&gt;sumW() &gt; <span class="hljs-number">0.</span>) {
            scale(_histNch[itype][ihist],
              (<span class="hljs-number">1.</span> / _counterSOW[itype][ihist]-&gt;sumW() / <span class="hljs-number">2.</span> / M_PI));
          }
        }
      }

      <span class="hljs-comment">// Postprocessing of the histograms</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> ihist = <span class="hljs-number">0</span>; ihist &lt; NHISTOS; ++ihist) {
        <span class="hljs-comment">// If there are entires in histograms for both beam types</span>
        <span class="hljs-keyword">if</span> (_histNch[PP][ihist]-&gt;numEntries() &gt; <span class="hljs-number">0</span> &amp;&amp; _histNch[PBPB][ihist]-&gt;numEntries() &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-comment">// Initialize and fill R_AA histograms</span>
          divide(_histNch[PBPB][ihist], _histNch[PP][ihist], _histRAA[ihist]);
          <span class="hljs-comment">// Scale by Ncoll. Unfortunately some generators does not provide</span>
          <span class="hljs-comment">// Ncoll value (eg. JEWEL), so the following scaling will be done</span>
          <span class="hljs-comment">// only if there are entries in the counters</span>
          <span class="hljs-keyword">double</span> ncoll = _counterNcoll[ihist]-&gt;sumW();
          <span class="hljs-keyword">double</span> sow = _counterSOW[PBPB][ihist]-&gt;sumW();
          <span class="hljs-keyword">if</span> (ncoll &gt; <span class="hljs-number">1e-6</span> &amp;&amp; sow &gt; <span class="hljs-number">1e-6</span>)
            _histRAA[ihist]-&gt;scaleY(<span class="hljs-number">1.</span> / (ncoll / sow));

        }
      }

    }

    <span class="hljs-comment">//@}</span>

  <span class="hljs-keyword">private</span>:

    <span class="hljs-keyword">bool</span> isHI;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> NHISTOS = <span class="hljs-number">15</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> EVENT_TYPES = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> PP = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> PBPB = <span class="hljs-number">1</span>;

    <span class="hljs-comment">/// @name Histograms</span>
    <span class="hljs-comment">//@{</span>
    Histo1DPtr _histNch[EVENT_TYPES][NHISTOS];
    CounterPtr _counterSOW[EVENT_TYPES][NHISTOS];
    CounterPtr _counterNcoll[NHISTOS];
    Scatter2DPtr _histRAA[NHISTOS];
    <span class="hljs-comment">//@}</span>

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>&gt;&gt; _centrRegions;

  };

  <span class="hljs-comment">// The hook for the plugin system</span>
  DECLARE_RIVET_PLUGIN(ALICE_2012_I1127497);


}
</code></pre>
<h2 id="event-mixing">Event mixing</h2>
<p><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(811479670);" id="warning"><i class="fa fa-info-circle"></i> WARNING<span id="heading-811479670"></span></h3></div><div class="panel-body" id="panel-811479670"><p>This feature is still under development and its usage might change in the coming versions of Rivet. Description of this procedure was prepared for Rivet version 2.7.2.</p>
</div></div></p>
<p>Event mixing is a procedure that enables to project out an event mixed of several events. In Rivet it is implemented in a form of a projection class called EventMixingProjection. It is based on a mixing observable provided as an input to define what should qualify as a mixable event, where the mixing observable can be defined as number of final state particles, centrality, event plane angle, etc. It contains a buffer that is filled with events over the runtime. This buffer can be used within an analysis to perform required operations. A declaration of an event mixing projection looks like this:</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span> <span class="hljs-params">()</span> </span>{
  [...]
  <span class="hljs-comment">// Charged final state to manage the mixing observable</span>
  <span class="hljs-function">ChargedFinalState <span class="hljs-title">cfsMult</span><span class="hljs-params">(Cuts::abseta &lt; <span class="hljs-number">0.8</span>)</span></span>;
  addProjection(cfsMult, <span class="hljs-string">&quot;CFSMult&quot;</span>);
  <span class="hljs-comment">// Primary particles.</span>
  <span class="hljs-function">PrimaryParticles <span class="hljs-title">pp</span><span class="hljs-params">({Rivet::PID::PIPLUS, Rivet::PID::KPLUS, 
  Rivet::PID::K0S, Rivet::PID::K0L, Rivet::PID::PROTON, 
  Rivet::PID::NEUTRON, Rivet::PID::LAMBDA, Rivet::PID::SIGMAMINUS,
  Rivet::PID::SIGMAPLUS, Rivet::PID::XIMINUS, Rivet::PID::XI0, 
  Rivet::PID::OMEGAMINUS},Cuts::abseta &lt; etamax &amp;&amp; Cuts::pT &gt; pTmin*GeV)</span></span>;
  addProjection(pp,<span class="hljs-string">&quot;APRIM&quot;</span>);
  <span class="hljs-comment">// The event mixing projection</span>
  declare(EventMixingFinalState(&amp;cfsMult, pp, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">10</span>),<span class="hljs-string">&quot;EVM&quot;</span>);

  [...]
}
</code></pre>
<p>In this case the first parameter of the event mixing projection defines a mixing observable. The second parameter is used to project out an event that is added to the buffer. The other parameters are: number of events to mix, minimal and maximal value of the mixing observable, and number of bins for that observable (so that for each bin there is a separate buffer). One can use it in the analyze method like this:</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">analyze</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Event&amp; event)</span> </span>{
  [...]
  <span class="hljs-keyword">const</span> EventMixingFinalState&amp; evm = applyProjection&lt;EventMixingFinalState&gt;(event, <span class="hljs-string">&quot;EVM&quot;</span>);
  <span class="hljs-comment">// Test if we have enough mixing events available to continue.</span>
  <span class="hljs-keyword">if</span> (!evm.hasMixingEvents()) <span class="hljs-keyword">return</span>;
  <span class="hljs-comment">// Loop over the particles in the mixing buffer</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> Particle&amp; pMix : evm.particles()){
    [...]
  }
  [...]
}
</code></pre>
<p>This enables to check if we already have enough events in our buffer (method hasMixingEvents will return false in case the number of events in the buffer is lower than requested) and gives us access to the mixing buffer within the analysis. Note, that in this case first few events will be skipped as we require our buffers to be filled before going further. Full example can be found here:</p>
<pre><code class="lang-cpp">// -*- C++ -*-
#include &quot;Rivet/Analysis.hh&quot;
#include &quot;Rivet/Projections/AliceCommon.hh&quot;
#include &quot;Rivet/Projections/PrimaryParticles.hh&quot;
#include &quot;Rivet/Projections/ChargedFinalState.hh&quot;
#include &quot;Rivet/Projections/EventMixingFinalState.hh&quot;
namespace Rivet {


  /// @brief Correlations of identified particles in pp.
  /// Also showcasing use of EventMixingFinalState.

  class ALICE_2016_I1507157 : public Analysis {
  public:

    /// Constructor
    DEFAULT_RIVET_ANALYSIS_CTOR(ALICE_2016_I1507157);


    /// @name Analysis methods
    //@{

    /// @brief Calculate angular distance between particles.
    double phaseDif(double a1, double a2){
      double dif = a1 - a2;
      while (dif &lt; -M_PI/2)
        dif += 2*M_PI;
      while (dif &gt; 3*M_PI/2)
        dif -= 2*M_PI;
      return dif;
    }


    /// Book histograms and initialise projections before the run
    void init() {

      double etamax = 0.8;
      double pTmin = 0.5; // GeV 

      // Trigger
      declare(ALICE::V0AndTrigger(), &quot;V0-AND&quot;);
      // Charged tracks used to manage the mixing observable.
      ChargedFinalState cfsMult(Cuts::abseta &lt; etamax);
      addProjection(cfsMult, &quot;CFSMult&quot;);

      // Primary particles.
      PrimaryParticles pp({Rivet::PID::PIPLUS, Rivet::PID::KPLUS, 
    Rivet::PID::K0S, Rivet::PID::K0L, Rivet::PID::PROTON, 
    Rivet::PID::NEUTRON, Rivet::PID::LAMBDA, Rivet::PID::SIGMAMINUS,
           Rivet::PID::SIGMAPLUS, Rivet::PID::XIMINUS, Rivet::PID::XI0, 
    Rivet::PID::OMEGAMINUS},Cuts::abseta &lt; etamax &amp;&amp; Cuts::pT &gt; pTmin*GeV);
      addProjection(pp,&quot;APRIM&quot;);

      // The event mixing projection
      declare(EventMixingFinalState(&amp;cfsMult, pp, 5, 0, 100, 10),&quot;EVM&quot;);
      // The particle pairs.
      pid = {{211, -211}, {321, -321}, {2212, -2212}, {3122, -3122}, {211, 211},
             {321, 321}, {2212, 2212}, {3122, 3122}, {2212, 3122}, {2212, -3122}};
      // The associated histograms in the data file.
      vector&lt;string&gt; refdata = {&quot;d04-x01-y01&quot;,&quot;d04-x01-y02&quot;,&quot;d04-x01-y03&quot;,
        &quot;d06-x01-y02&quot;,&quot;d05-x01-y01&quot;,&quot;d05-x01-y02&quot;,&quot;d05-x01-y03&quot;,&quot;d06-x01-y01&quot;,
        &quot;d01-x01-y02&quot;,&quot;d02-x01-y02&quot;};
      for (int i = 0, N = refdata.size(); i &lt; N; ++i) {
        // The ratio plots.
    ratio.push_back(bookScatter2D(refdata[i], true));
    // Signal and mixed background.
        signal.push_back(bookHisto1D(&quot;/TMP/&quot; + refdata[i] +
            &quot;-s&quot;, *ratio[i], refdata[i] + &quot;-s&quot;));    
        background.push_back(bookHisto1D(&quot;/TMP/&quot; + refdata[i] + 
            &quot;-b&quot;, *ratio[i], refdata[i] + &quot;-b&quot;));    
        // Number of signal and mixed pairs.
    nsp.push_back(0.);
        nmp.push_back(0.);
      } 
    }


    /// Perform the per-event analysis
    void analyze(const Event&amp; event) {
      const double weight = event.weight();

      // Triggering
      if (!apply&lt;ALICE::V0AndTrigger&gt;(event, &quot;V0-AND&quot;)()) return;
      // The projections
      const PrimaryParticles&amp; pp = 
        applyProjection&lt;PrimaryParticles&gt;(event,&quot;APRIM&quot;);
      const EventMixingFinalState&amp; evm = 
        applyProjection&lt;EventMixingFinalState&gt;(event, &quot;EVM&quot;);

      // Test if we have enough mixing events available to continue.
      if (!evm.hasMixingEvents()) return;

      for(const Particle&amp; p1 : pp.particles()) {
        // Start by doing the signal distributions
    for(const Particle&amp; p2 : pp.particles()) {
      if(isSame(p1,p2))
        continue;
      double dEta = abs(p1.eta() - p2.eta());
      double dPhi = phaseDif(p1.phi(), p2.phi());
      if(dEta &lt; 1.3) {
        for (int i = 0, N = pid.size(); i &lt; N; ++i) {
          int pid1 = pid[i].first;
          int pid2 = pid[i].second;
          bool samesign = (pid1 * pid2 &gt; 0);
          if (samesign &amp;&amp; ((pid1 == p1.pid() &amp;&amp; pid2 == p2.pid()) || 
         (pid1 == -p1.pid() &amp;&amp; pid2 == -p2.pid()))) {
            signal[i]-&gt;fill(dPhi, weight);
        nsp[i] += 1.0;
          }
          if (!samesign &amp;&amp; abs(pid1) == abs(pid2) &amp;&amp;
          pid1 == p1.pid() &amp;&amp; pid2 == p2.pid()) {
                signal[i]-&gt;fill(dPhi, weight);
            nsp[i] += 1.0;
          }
          if (!samesign &amp;&amp; abs(pid1) != abs(pid2) &amp;&amp; 
          ( (pid1 == p1.pid() &amp;&amp; pid2 == p2.pid()) ||
          (pid2 == p1.pid() &amp;&amp; pid1 == p2.pid()) ) ) {
                signal[i]-&gt;fill(dPhi, weight);
            nsp[i] += 1.0;
          }
        }
      }
    }
    // Then do the background distribution
    for(const Particle&amp; pMix : evm.particles()){
      double dEta = abs(p1.eta() - pMix.eta());
      double dPhi = phaseDif(p1.phi(), pMix.phi());
      if(dEta &lt; 1.3) {
        for (int i = 0, N = pid.size(); i &lt; N; ++i) {
          int pid1 = pid[i].first;
          int pid2 = pid[i].second;
          bool samesign = (pid1 * pid2 &gt; 0);
          if (samesign &amp;&amp; ((pid1 == p1.pid() &amp;&amp; pid2 == pMix.pid()) || 
         (pid1 == -p1.pid() &amp;&amp; pid2 == -pMix.pid()))) {
                background[i]-&gt;fill(dPhi, weight);
            nmp[i] += 1.0;
          }
          if (!samesign &amp;&amp; abs(pid1) == abs(pid2) &amp;&amp;
          pid1 == p1.pid() &amp;&amp; pid2 == pMix.pid()) {
                background[i]-&gt;fill(dPhi, weight);
            nmp[i] += 1.0;
          }
          if (!samesign &amp;&amp; abs(pid1) != abs(pid2) &amp;&amp; 
          ( (pid1 == p1.pid() &amp;&amp; pid2 == pMix.pid()) ||
          (pid2 == p1.pid() &amp;&amp; pid1 == pMix.pid()) ) ) {
                background[i]-&gt;fill(dPhi, weight);
            nmp[i] += 1.0;
          }
        }
      }
    }
      }
    }


    /// Normalise histograms etc., after the run
    void finalize() {
      for (int i = 0, N = pid.size(); i &lt; N; ++i) {
        double sc = nmp[i] / nsp[i];
    signal[i]-&gt;scaleW(sc);
    divide(signal[i],background[i],ratio[i]);
      }
    }

    //@}


    /// @name Histograms
    //@{
    vector&lt;pair&lt;int, int&gt; &gt; pid;
    vector&lt;Histo1DPtr&gt; signal;
    vector&lt;Histo1DPtr&gt; background;
    vector&lt;Scatter2DPtr&gt; ratio;
    vector&lt;double&gt; nsp;
    vector&lt;double&gt; nmp;

    //@}

  };

  // The hook for the plugin system
  DECLARE_RIVET_PLUGIN(ALICE_2016_I1507157);

}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="advanced-topics.html" class="navigation navigation-prev " aria-label="Previous page: Advanced topics">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="coding-conventions.html" class="navigation navigation-next " aria-label="Next page: Coding conventions for Rivet plugins">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Advanced heavy-ion features","level":"1.6.8","depth":2,"next":{"title":"Coding conventions for Rivet plugins","level":"1.6.9","depth":2,"path":"rivet/coding-conventions.md","ref":"rivet/coding-conventions.md","articles":[]},"previous":{"title":"Advanced topics","level":"1.6.7","depth":2,"path":"rivet/advanced-topics.md","ref":"rivet/advanced-topics.md","articles":[]},"dir":"ltr"},"config":{"plugins":["katex","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#117012fdc18c96831cb88196980c0ea73b0c87b8","collapsible-menu","block-align","page-toc"],"styles":{"website":"css/website.css"},"pluginsConfig":{"collapsible-menu":{},"block-align":{},"search":{},"page-toc":{"position":"before-first","selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4","showByDefault":true},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"katex":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"ALICE Analysis Tutorial","gitbook":"*","description":"Introduction to the common analysis techniques and tools of ALICE"},"file":{"path":"rivet/advanced-hi-features.md","mtime":"2024-02-20T15:53:38.276Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-02-20T15:54:24.309Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/anchor-3.1.1.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/page-toc.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

